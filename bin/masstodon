#!/usr/bin/env python2

# -*- coding: utf-8 -*-
#   Copyright (C) 2016 Mateusz Krzysztof Łącki and Michał Startek.
#
#   This file is part of MassTodon.
#
#   MassTodon is free software: you can redistribute it and/or modify
#   it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
#   Version 3.
#
#   MassTodon is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#
#   You should have received a copy of the GNU AFFERO GENERAL PUBLIC LICENSE
#   Version 3 along with MassTodon.  If not, see
#   <https://www.gnu.org/licenses/agpl-3.0.en.html>.
#
# ................................................................................
# ............~MMM:...............................................................
# ..........:M....NM..............................................................
# ..........8M,....M,.............................................................
# ............M~...8O.............................................................
# ..........+.MM,..,M..............................?MMMMMN=.......................
# ..........:..:M:..M..........................DMMM~..  ....MMMM$.................
# ..........+...DN..M...............+MMMMMMMMMMM............... $MMM=.............
# ..........?...OM..M=............ZMD...... .......................ZMM?...........
# ..........:...?M..8O...........M,...................................MM,.........
# ..........+...7M..~M..........M......................................OMM........
# ..........+...IM...M.........MI....................................... MM.......
# ..........:...ZM...M.........M...M?.8D..................................MM......
# ..........:...DM...M:.......M:..M....,O.................................?M:.....
# ..............NM...~M......OM...M....8:..................................MM.....
# ...........$..ZM....MO.....M.....DMMM.....................................M,....
# ...........Z..,M.....MM..8M:..............................................MO....
# ..........:Z...MN......DMO................................................MM....
# ..........:Z...~M~........................................................7M....
# ..........?Z....$M7........................................................M....
# ..........+Z.....=MM...........MZ..........................................,M...
# ..........~Z.......MMMM=....IMMMM..~M....................................:M.M...
# ..........=Z......:...IMMMMMZ..MI..NMM....................................NM=...
# ..........+Z......MMZ.........OM...M,.M....................................M+...
# ..........:Z.....Z.M.,MMMIIDMMM....M..M.N~..................................M...
# ..........:Z.....Z..MM...........~MD..M.MM................................M,M7..
# ..........:Z.....Z....7MMMO:~8MMM7...ND.MN................................MM:+..
# ..........:Z.....Z..................?I..MD................................M.M...
# ..........=$.....?.....................MZN................................M+....
# ..........ZZ.....7....................MD.M........MMM..N,..M...M7M........MO....
# ..........Z$~....?.......................M........M..M.~D.~N..:,.M........MO....
# ..........ZZ,....$.... .......=..........M........M:.M..D..M..+=.M,.......MO....
# ........~.ZZ?....$....=.......=..........MM......?M,.,...........MM......8M=....
# .$I.,.IZ,I.+,~I.,....~~..7Z.Z.:...=.,$Z...~8MMMMMMI..............~MMMMMMMM8.....
# ................................................................................
# ................................................................................
# ................................................................................
# .7O......O............................ZZZZZZZ..............Z....................
# .7......I$...............................Z.................Z....................
# .7.Z....O7....,ZZZ.....OZZ......ZZO .....Z.....OZZ......OZOZ....,ZZO....ZOOZ+...
# .7..$..Z.7...7....Z...Z....=.......O.....Z....O....?...=...?...I....Z...Z....O..
# .7..O..~.7........Z.. Z........7.........Z....O....O...O...O...Z....Z...O....Z..
# .7...ZZ..7.....8Z.Z.....O.......$Z.......Z....O....O...O...O...Z....Z...O....Z..
# .7...~...7...Z....Z.......7........O.....Z....O....O...O...O...Z....Z...O....Z..
# .7.......7...O....O...O... I.......Z.....Z....Z... $...O...O...$....O...O....Z..
# .7.......7....OOOOO....ZOZI....:ZOZ......Z.....ZOZ7.....OZZ.....7ZOZ....Z....Z..
# ................................................................................


import argparse
from collections import defaultdict
import json
import os
from pprint import pprint
import re

from MassTodonPy.Data.Constants import eps
from MassTodonPy.CLI.MassTodon_wrapper import run_masstodon
from MassTodonPy.MassTodon import MassTodon
from MassTodonPy.Parsers.blocked_fragments import parse_blocked_fragments
from MassTodonPy.Parsers.Paths import parse_path


def add_backslash(p):
    if p[-1] != '/':
        p += '/'
    return p

parser = argparse.ArgumentParser()

# Spectrum & Output
parser.add_argument("spectrum",
                    help="path to the spectrum file, with spectrum file extension: either '.txt', '.mzxml', or '.mzml', case insensitive.")
parser.add_argument("-o",
                    "--output_path",
                    dest='output',
                    help="Path to the output.\
                          If not provided, spectrum is used path by default.",
                    default='output/',
                    type=add_backslash)

parser.add_argument("fasta",
                    help="The FASTA sequence of the protein to study.")
parser.add_argument("charge",
                    type=int,
                    help="The initial charge of the precursor filtered out in MS1.")
parser.add_argument("mz_tol",
                    type=float,
                    help="The tolerance in the m/z axis.")
parser.add_argument("-name",
                    help="The precursor's name.",
                    default='')

# Handling the modifications
# modifications = "11 C_carbo H=-1 N=1 O=-1|10 C_carbo H=-1 N=1 O=-10"
def modification(modifications):
    """Parses modifications.

    Parameters
    ==========
    modifications : str
        E.g. "11 C_carbo H=-1 N=1 O=-1|10 C_carbo H=-1 N=1 O=-10"
    """
    output = defaultdict(dict)
    modifications = modifications.split('|')
    for mod in modifications:
        mod = mod.split()
        aa_no, aa_type = mod[0:2]
        diffs = {}
        for d in mod[2:]:
            element, diff = d.split('=')
            diffs[element] = int(diff)
        output[int(aa_no)][aa_type] = diffs
    return dict(output)

parser.add_argument("-modifications",
                    help="String with modifications of individual amino acids.\n\
                    Follows the scheme: '<amino acid number> <C_alpha|C_carbo|N> <element>=<integer difference> .. <element>=<integer difference> | ...'.\
                    For example: '11 C_carbo H=-1 N=1 O=-1|10 C_carbo H=-1 N=1 O=-10'",
                    type=modification)

# Fragments
parser.add_argument("-fragments",
                    help="Only 'cz' accepted for now. Planning other fragmentation schemes, including inner fragments.",
                    default='cz')
parser.add_argument("-blocked_fragments",
                    help="Fragments you don't want to include, e.g. 'z5', or 'c13z21c12c53z1': no spaces between diffferent names.",
                    type=parse_blocked_fragments,
                    default='c0')
parser.add_argument("--unblock_prolines",
                    dest='block_prolines',
                    action='store_const',
                    const=False,
                    default=True,
                    help="Stop blocking prolines from fragmenting.")
# Precursor settings
parser.add_argument("-distance_charges",
                    help="The minimal distance between charges on the fasta sequence. Defaults to charges being 4 amino acids apart.",
                    type=int,
                    default=5)

# Spectrum Thresholds
parser.add_argument("-min_intensity",
                    help="Experimental peaks with lower height will be trimmed.",
                    type=float,
                    default=eps)
parser.add_argument("-percent_top_peaks",
                    help="Percentage of the heighest peaks in the spectrum to be included.",
                    type=float,
                    default=1.0)
# Graph Construction and Deconvolution
parser.add_argument("-deconvolution_method",
                    help="Matteo = MassTodon paper deconvolution. Ciacho_Wanda = experimental gaussian kernel deconvolution.",
                    default='Matteo')
parser.add_argument("-joint_probability",
                    help="The joint probability of the calculated isotopic distribution. Defaults to a decent '0.999'.",
                    type=float,
                    default=.999)
parser.add_argument("-min_prob_per_molecule",
                    help="The minimal probability an envelope has to scoop to be included in the deconvolution graph.",
                    type=float,
                    default=.7)
parser.add_argument("-max_buffer_len",
                    dest='max_buffer_len',
                    help="The maximal length of the visual buffer between peaks, i.e. the big rectangle width.",
                    type=float,
                    default=.5)
parser.add_argument("-L1_flow",
                    dest='_L1_flow',
                    help="L1 penalty for high flows of intensities.",
                    type=float,
                    default=.01)
parser.add_argument("-L2_flow",
                    dest="_L1_flow",
                    help="L2 penalty (a.k.a. ridge regression like) for high flows of intensities.",
                    type=float,
                    default=.01)
parser.add_argument("-L1_intensity",
                    dest="_L1_intensity",
                    help="L1 penalty for high intensity estimates.",
                    type=float,
                    default=.01)
parser.add_argument("-L2_intensity",
                    dest="_L2_intensity",
                    help="L2 penalty (a.k.a. ridge regression like) for high intensities.",
                    type=float,
                    default=.01)
parser.add_argument("-max_times",
                    dest="_max_times",
                    help="The maximal number of times to run CVXOPT.",
                    type=int,
                    default=10)
parser.add_argument("--show_progress",
                    dest="show_progress",
                    action='store_const',
                    const=True,
                    default=False,
                    help="Show progress of the CVXOPT calculations.")
parser.add_argument("-maxiters",
                    dest='_maxiters',
                    type=int,
                    help="Maximum number of steps for the CVXOPT algorithm.",
                    default=1000)
parser.add_argument("-sigma2",
                    help="Variance of the experimental peak's m/z ratio.",
                    type=float,
                    default=.1)
parser.add_argument("-ni2",
                    help="Variance of the theoretic isotopologue's m/z ratio.",
                    type=float,
                    default=.1)
# spectrum plot args
parser.add_argument("--no_spectrum_plot",
                    dest='spectrum_plot',
                    action='store_const',
                    const=False,
                    default=True,
                    help="Skip the spectrum plot.")
parser.add_argument("--show_spectrum_plot",
                    dest='show_spectrum_plot',
                    action='store_const',
                    const=True,
                    default=False,
                    help="Show spectrum plot.")
parser.add_argument("-spectrum_plot_width",
                    dest='width_spectrum_plot',
                    default=800,
                    type=int,
                    help="Width of the spectrum plot.")
parser.add_argument("-spectrum_plot_height",
                    dest='height_spectrum_plot',
                    default=600,
                    type=int,
                    help="Height of the spectrum plot.")
# aggregated precursors plot
parser.add_argument("--no_aggregated_precursors_plot",
                    dest='aggregated_precursors_plot',
                    action='store_const',
                    const=False,
                    default=True,
                    help="Skip the plot of aggregated precursors.")
parser.add_argument("--show_aggregated_precursors_plot",
                    dest='show_aggregated_precursors_plot',
                    action='store_const',
                    const=True,
                    default=False,
                    help="Do not show the aggregated precursors plot.")
parser.add_argument("-aggregated_precursors_plot_width",
                    dest='width_aggregated_precursors_plot',
                    default=800,
                    type=int,
                    help="Width of the plot of aggregated precursors.")
parser.add_argument("-spectrum_height",
                    dest='height_aggregated_precursors_plot',
                    default=600,
                    type=int,
                    help="Height of the plot of aggregated precursors.")
# fragments intensity plot
parser.add_argument("--no_fragments_intensity_plot",
                    dest='fragments_intensity_plot',
                    action='store_const',
                    const=False,
                    default=True,
                    help="Do not show the fragments intensity plot.")
parser.add_argument("--show_fragments_intensity_plot",
                    dest='show_fragments_intensity_plot',
                    action='store_const',
                    const=True,
                    default=False,
                    help="Show the plot of the fragments' intensity.")
parser.add_argument("-fragments_intensity_plot_width",
                    dest='width_fragments_intensity_plot',
                    help="Width of the fragments intensity plot.",
                    default=1000,
                    type=int)
parser.add_argument("-fragments_intensity_plot_height",
                    dest='height_fragments_intensity_plot',
                    help="Height of the fragments intensity plot.",
                    default=400,
                    type=int)
# verbosity
parser.add_argument("--verbose",
                    dest='verbose',
                    action='store_const',
                    const=True,
                    default=False,
                    help="Print out the messages from MassTodon.")
# parsing & making a dictionary
args = parser.parse_args().__dict__
# Renaming variables for plotting
plots = {}
if args.pop('spectrum_plot'):
    plots['spectrum_plot_args'] = dict(width=args.pop('width_spectrum_plot'),
                                       height=args.pop('height_spectrum_plot'),
                                       show=args.pop('show_spectrum_plot'))
if args.pop('aggregated_precursors_plot'):
    plots['aggregated_precursors_plot_args'] = dict(width=args.pop('width_aggregated_precursors_plot'),
                                                    height=args.pop('height_aggregated_precursors_plot'),
                                                    show=args.pop('show_aggregated_precursors_plot'))
if args.pop('fragments_intensity_plot'):
    plots['fragments_intensity_plot_args'] = dict(width=args.pop('width_fragments_intensity_plot'),
                                                  height=args.pop('height_fragments_intensity_plot'),
                                                  show=args.pop('show_fragments_intensity_plot'))
# Running the bloody software . . .
if args['verbose']:
    print('\nWelcome to MassTodon!')
    print('\tRunning MassTodon.')
output = args.pop('output')
if not os.path.exists(output):
    os.makedirs(output)
max_times = args.pop("_max_times")
run_masstodon(masstodon_args=args,
              output=output,
              _max_times_run_masstodon=max_times,
              _verbose=args['verbose'],
              **plots)
print('\nThank you for using MassTodonPy!\n')
